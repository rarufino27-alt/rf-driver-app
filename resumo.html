<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Resumo ‚Äì 5 Estrelas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="./theme/theme.css">

<style>
:root{
  --wine-dark:#2B0F14;
  --wine:#4A1A22;
  --gold:#C9A24D;
  --gold-soft:#E6C97A;
  --text:#2a2a2a;
}

body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(180deg,#ffffff 0%,#f4f1f2 60%,#efe9eb 100%);
  font-family:Inter, Arial, sans-serif;
  color:var(--text);
}

.page{
  min-height:100vh;
  display:flex;
  justify-content:center;
  padding:20px;
}

.container{
  width:100%;
  max-width:420px;
  display:flex;
  flex-direction:column;
  gap:18px;
}

.header{
  text-align:center;
  padding:22px;
  border-radius:24px;
  background:linear-gradient(135deg,var(--wine-dark),var(--wine));
  box-shadow:0 14px 36px rgba(0,0,0,.22);
  color:#fff;
}

.header h1{
  font-size:1.3rem;
  font-weight:800;
  letter-spacing:2px;
}

.header .stars{
  margin:8px 0 6px;
  color:var(--gold);
  letter-spacing:4px;
}

.block{
  background:#fff;
  border-radius:20px;
  padding:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.1);
}

.route{font-size:.9rem;line-height:1.5;}

.option{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border-radius:14px;
  border:1px solid #eee;
  margin-bottom:8px;
}

.details div{
  display:flex;
  justify-content:space-between;
  font-size:.85rem;
  margin-bottom:6px;
}

.totalBox{
  background:linear-gradient(135deg,var(--wine-dark),var(--wine));
  color:#fff;
  border-radius:22px;
  padding:18px;
  text-align:center;
  box-shadow:0 14px 36px rgba(0,0,0,.22);
}

.totalBox .label{font-size:.8rem;opacity:.9;}
.total{font-size:2.3rem;font-weight:900;color:var(--gold);}

input,select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid #ccc;
}

.btn-main{
  padding:16px;
  border-radius:18px;
  border:none;
  background:linear-gradient(180deg,var(--gold-soft),var(--gold));
  font-weight:900;
  cursor:pointer;
}

.btn-back{
  padding:14px;
  border-radius:16px;
  border:1px solid #ccc;
  background:#fff;
}

.signature{
  background:#fff;
  border-radius:18px;
  padding:14px;
  font-size:.85rem;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}
</style>
</head>

<body>

<div class="page">
<div class="container">

  <div class="header">
    <h1>RESUMO DA CORRIDA</h1>
    <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
  </div>

  <div class="block route">
    <strong>üìç Origem</strong><br>
    <span id="origemTxt"></span><br><br>
    <strong>üèÅ Destino</strong><br>
    <span id="destinoTxt"></span>
  </div>

  <div class="block">
    <label>üöñ Tipo de viagem</label>
    <select id="tipoViagem">
      <option value="ida">Ida</option>
      <option value="bate_volta">Bate e volta (+80%)</option>
      <option value="ida_volta">Ida e volta (x2)</option>
      <option value="ida_volta_espera">Ida e volta + espera</option>
    </select>
  </div>

  <div class="block">
    <div class="option"><span>üõ£Ô∏è Desvio simples</span><input type="checkbox" id="desvioSimples"></div>
    <div class="option"><span>üèñÔ∏è Volta da praia</span><input type="checkbox" id="voltaPraia"></div>
    <div class="option"><span>üß∫ Taxa de feira</span><input type="checkbox" id="taxaFeira"></div>
  </div>

  <div class="block">
    <label>üê∂ Transporte de animal</label>
    <select id="animal">
      <option value="0">N√£o</option>
      <option value="5">Pequeno</option>
      <option value="7">M√©dio</option>
      <option value="10">Grande</option>
      <option value="20">Viagem longa</option>
    </select>
  </div>

  <div class="block">
    <label>‚è±Ô∏è Tempo de espera (min)</label>
    <input type="number" id="tempoEspera">
  </div>

  <div class="block">
    <label>‚ûï Desvio adicional</label>
    <input type="number" id="desvioExtra">
  </div>

  <div class="block">
    <strong>Detalhamento</strong>
    <div class="details" id="detalhamento"></div>
  </div>

  <div class="totalBox">
    <div class="label">Valor total da corrida</div>
    <div class="total" id="total">R$ 0,00</div>
  </div>

  <div class="signature" id="assinatura"></div>

  <button id="btnWhats" class="btn-main">Enviar no WhatsApp</button>
  <button class="btn-back" onclick="App.go('destino.html')">Voltar</button>

</div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./core/supabase.js"></script>
<script src="./core/global.js"></script>
<script src="./core/taxas.js"></script>

<script>
/* ================= PROTE√á√ÉO ================= */
(async () => {
  await App.requireAuth(["passageiro","motorista","admin"]);
})();

const origem = App.getState("origem");
const destino = App.getState("destino");
if(!origem || !destino) App.go("dashboard-passageiro.html");

/* ================= DADOS ================= */
document.getElementById("origemTxt").innerText = origem;
document.getElementById("destinoTxt").innerText = destino;

const valorBase = Number(App.getState("valorBase") || 0);

/* ================= USU√ÅRIO ================= */
const user = App.user;
const role = App.role;

/* ================= ELEMENTOS ================= */
const tipoViagem = document.getElementById("tipoViagem");
const desvioSimples = document.getElementById("desvioSimples");
const voltaPraia = document.getElementById("voltaPraia");
const taxaFeira = document.getElementById("taxaFeira");
const animalSel = document.getElementById("animal");
const tempoEsperaInput = document.getElementById("tempoEspera");
const desvioExtraInput = document.getElementById("desvioExtra");
const detalhamento = document.getElementById("detalhamento");
const totalEl = document.getElementById("total");
const assinatura = document.getElementById("assinatura");
const btnWhats = document.getElementById("btnWhats");

/* ================= CPF MASK ================= */
function maskCPF(cpf){
  if(!cpf) return "";
  return cpf.substring(0,3) + "********";
}

/* ================= ASSINATURA ================= */
if(role === "motorista"){
  assinatura.innerHTML = `
<strong>MOTORISTA</strong><br>
${user.user_metadata?.nome || ""}<br>
*VE√çCULO* ${user.user_metadata?.veiculo || ""}<br>
*PLACA* ${user.user_metadata?.placa || ""}<br>
*CPF* ${maskCPF(user.user_metadata?.cpf)}
`;
}else if(role === "admin"){
  assinatura.innerHTML = `<strong>ADMINISTRADOR</strong><br>${user.user_metadata?.nome || ""}`;
}else{
  assinatura.style.display = "none";
  btnWhats.style.display = "none";
}

/* ================= C√ÅLCULO ================= */
function calcular(){
  let total = valorBase;
  let detalhes = [];

  detalhes.push(`üöñ Viagem base: R$ ${valorBase.toFixed(2)}`);

  if(tipoViagem.value !== "ida"){
    let extra = 0;
    if(tipoViagem.value === "bate_volta") extra = valorBase*0.8;
    if(tipoViagem.value === "ida_volta") extra = valorBase;
    if(tipoViagem.value === "ida_volta_espera") extra = valorBase*1.2;
    total += extra;
    detalhes.push(`‚ôªÔ∏è Tipo de viagem: +R$ ${extra.toFixed(2)}`);
  }

  if(desvioSimples.checked){ total+=Taxas.desvioRotaSimples; detalhes.push(`üõ£Ô∏è Desvio simples: +R$ ${Taxas.desvioRotaSimples.toFixed(2)}`); }
  if(voltaPraia.checked){ total+=Taxas.voltaPraia; detalhes.push(`üèñÔ∏è Volta da praia: +R$ ${Taxas.voltaPraia.toFixed(2)}`); }
  if(taxaFeira.checked){ total+=Taxas.feira; detalhes.push(`üß∫ Taxa de feira: +R$ ${Taxas.feira.toFixed(2)}`); }

  const animal = Number(animalSel.value||0);
  if(animal){ total+=animal; detalhes.push(`üê∂ Animal: +R$ ${animal.toFixed(2)}`); }

  const minutos = Number(tempoEsperaInput.value||0);
  if(minutos>=5){
    const espera = 3 + (minutos-5)*0.6;
    total+=espera;
    detalhes.push(`‚è±Ô∏è Espera: +R$ ${espera.toFixed(2)}`);
  }

  const extra = Number(desvioExtraInput.value||0);
  if(extra){ total+=extra; detalhes.push(`‚ûï Extra: +R$ ${extra.toFixed(2)}`); }

  detalhamento.innerHTML = detalhes.map(d=>`<div>${d}</div>`).join("");
  totalEl.innerText = `R$ ${total.toFixed(2)}`;
  App.setState("total", total);
  window.__whatsDetalhes = detalhes;
}

document.querySelectorAll("input,select").forEach(e=>e.addEventListener("change",calcular));
calcular();

/* ================= WHATSAPP ================= */
btnWhats.onclick = ()=>{
  const total = App.getState("total");

  const assinaturaTxt =
role==="motorista"
? `*MOTORISTA* ${user.user_metadata?.nome}\n*VEICULO* ${user.user_metadata?.veiculo}\n*PLACA* ${user.user_metadata?.placa}\n*CPF* ${maskCPF(user.user_metadata?.cpf)}`
: `*ADMINISTRADOR* ${user.user_metadata?.nome}`;

  const msg =
`üí´ *5 Estrelas‚Äì RECIBO de viagem*

üìå *Origem*: ${origem}
üèÅ *Destino*: ${destino}

*Detalhamento*
${window.__whatsDetalhes.join("\n")}

üí∞ *Total*: R$ ${total.toFixed(2)}

${assinaturaTxt}

Conforto, seguran√ßa e transpar√™ncia.`;

  window.open("https://wa.me/?text="+encodeURIComponent(msg),"_blank");
};
</script>

</body>
</html>